<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <title>nl.koenvh.screendeck.myaction Property Inspector</title>
    <link rel="stylesheet" href="streamdeck-javascript-sdk/css/sdpi.css"/>
</head>

<body>
<div class="sdpi-wrapper">

            <div class="sdpi-item">
            <details class="message info" >
                <summary>How it works</summary>
                <div id="info_howto"><p>Set this tile to all the tiles on your Stream Deck. It will automatically play the right video part on the right tile. You can add your own tiles too, the video will simply be missing there. Press once on any of the streaming tiles to start the video, and press again to stop the video.</p></div>
            </details>
        </div>
        <div class="sdpi-item">
            <details class="message caution" >
                <summary>Using multiple tiles</summary>
                <div id="caution_tiles"><p>Set the stream URL only once! Setting multiple different stream URLs leads to undefined behaviour.</p></div>
            </details>
        </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label">Stream URL</div>
        <input class="sdpi-item-value" id="stream"  type="text" onchange="onchange_stream()"
               value="" placeholder="https://www.twitch.tv/Koenvh" >
    </div>

</div>

<!-- Stream Deck Libs -->
<script src="streamdeck-javascript-sdk/js/constants.js"></script>
<script src="streamdeck-javascript-sdk/js/prototypes.js"></script>
<script src="streamdeck-javascript-sdk/js/timers.js"></script>
<script src="streamdeck-javascript-sdk/js/utils.js"></script>
<script src="streamdeck-javascript-sdk/js/events.js"></script>
<script src="streamdeck-javascript-sdk/js/api.js"></script>
<script src="streamdeck-javascript-sdk/js/property-inspector.js"></script>
<script src="streamdeck-javascript-sdk/js/dynamic-styles.js"></script>
<script>
    console.log('Property Inspector loaded', $PI);

        const info_howto_el = document.getElementById("info_howto")
    const caution_tiles_el = document.getElementById("caution_tiles")
    const stream_el = document.getElementById("stream")

    let settings

    $PI.onConnected(jsn => {
        console.log('Property Inspector connected', jsn);
        console.log(jsn.actionInfo.payload.settings);
        settings = jsn.actionInfo.payload.settings;

                if (settings["info_howto"] !== undefined) {
            info_howto_el.innerHTML = settings.info_howto
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => `<p>${line}</p>`)
                .join('\n');
        } else {
            settings["info_howto"] = info_howto_el.textContent;
        }
        if (settings["caution_tiles"] !== undefined) {
            caution_tiles_el.innerHTML = settings.caution_tiles
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => `<p>${line}</p>`)
                .join('\n');
        } else {
            settings["caution_tiles"] = caution_tiles_el.textContent;
        }
        if (settings["stream"] !== undefined) {
            stream_el.value = settings.stream
        } else {
            settings["stream"] = stream_el.value
        }

        $PI.setSettings(settings);
    });

    $PI.onDidReceiveSettings("nl.koenvh.screendeck.myaction", jsn => {
        settings = jsn.payload.settings

                if (settings["info_howto"] !== undefined) {
            info_howto_el.innerHTML = settings.info_howto
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => `<p>${line}</p>`)
                .join('\n');
        } else {
            settings["info_howto"] = info_howto_el.textContent;
        }
        if (settings["caution_tiles"] !== undefined) {
            caution_tiles_el.innerHTML = settings.caution_tiles
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => `<p>${line}</p>`)
                .join('\n');
        } else {
            settings["caution_tiles"] = caution_tiles_el.textContent;
        }
        if (settings["stream"] !== undefined) {
            stream_el.value = settings.stream
        } else {
            settings["stream"] = stream_el.value
        }
    });

        const onchange_stream = () => {
        console.log(stream_el.value);
        settings["stream"] = stream_el.value;
        $PI.setSettings(settings);
    }

    function get_select_values_and_selected(element) {
        let values = [];
        for (let i = 0; i < element.options.length; i++) {
            let option = element.options[i];
            if (option.value === "null") {
                continue;
            }
            values.push(option.value);
        }
        let selected
        if (element.value === "null") {
            selected = null
        } else {
            selected = element.value
        }
        return {
            values: values,
            selected: selected
        };
    }

    function update_select_options(element, values, selected_value) {
        element.innerHTML = '';

        if (selected_value === null) {
            selected_value = "null";
        }

        const nullOption = document.createElement('option');
        nullOption.value = "null";
        nullOption.text = "";
        element.appendChild(nullOption);

        values.forEach(value => {
            if (value === null) {
                return;
            }
            const option = document.createElement('option');
            option.value = value;
            option.text = value;
            element.appendChild(option);
        });

        if (values.includes(selected_value)) {
            element.value = selected_value;
            return true
        } else {
            element.value = "null";
            return false
        }
    }

</script>
</body>

</html>
